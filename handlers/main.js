import { LocationAttachment, Keyboard } from '@maxhub/max-bot-api';
import { getAbiturientMenu } from '../keyboards/abiturient.js';
import { getUpcomingDeadlines } from '../config/deadlines.js'; // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç
import { parseScores } from '../handlers/calculator.js';

const WELCOME_IMAGE_URL = 'https://static.tildacdn.com/tild6234-3964-4832-b930-393763383461/196A0054_1.jpg';


async function sendWelcomeMessage(ctx) {
  const welcomeText = `–ü—Ä–∏–≤–µ—Ç! –¢—ã —Å—Ç–æ–∏—à—å –ø–µ—Ä–µ–¥ —Å–µ—Ä—å–µ–∑–Ω—ã–º –≤—ã–±–æ—Ä–æ–º –≤ —Å–≤–æ–µ–π –∂–∏–∑–Ω–∏, –∞ —è –ø–æ–º–æ–≥—É —Ç–µ–±–µ —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —ç—Ç–æ–º. –ß—Ç–æ –±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å–æ –º–Ω–æ–π –≤–≤–µ–¥–∏ –∫–æ–º–∞–Ω–¥—É /start`;

  await ctx.reply(welcomeText, {
    format: 'markdown'
  });
}

export function setupMainHandlers(bot) {
  // –°—Ç–∞—Ä—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞
  bot.command('start', async (ctx) => {
    const upcoming = getUpcomingDeadlines();
    
    let deadlineInfo = '';
    if (upcoming.length > 0) {
      const nearest = upcoming[0];
      deadlineInfo = `\n\n‚è∞ –ë–ª–∏–∂–∞–π—à–∏–π –¥–µ–¥–ª–∞–π–Ω: ${nearest.formattedDate} (—á–µ—Ä–µ–∑ ${nearest.daysLeft} –¥–Ω–µ–π)`;
    }

    const message = 
      `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –±–æ—Ç–∞ –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤ –î–í–§–£! üéì\n\n` +
      `–Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º:\n` +
      `‚Ä¢ –û—Ç–≤–µ—á—É –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n` +
      `‚Ä¢ –†–∞—Å—Å–∫–∞–∂—É –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏\n` +
      `‚Ä¢ –ü–æ–º–æ–≥—É —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —à–∞–Ω—Å—ã –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è\n` +
      `‚Ä¢ –ù–∞–ø–æ–º–Ω—é –æ –≤–∞–∂–Ω—ã—Ö –¥–∞—Ç–∞—Ö\n` + 
      `–ö–æ–Ω–∫—É—Ä—Å–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –∏ –¥–µ—Ç–∞–ª–∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º —Å–∞–π—Ç–µ –î–í–§–£ https://postupi.dvfu.ru/`;

       try {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ URL
        const image = await ctx.api.uploadImage({ 
          url: WELCOME_IMAGE_URL 
        });

        
        await ctx.reply(message, {
          format: 'markdown',
          attachments: [image.toJson(), getAbiturientMenu()]
        });

      }
      catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error);
        
        // Fallback: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
        await ctx.reply(message, {
          format: 'markdown',
          attachments: [getAbiturientMenu()]
        });
      }
  });

  bot.on('bot_started', async (ctx) => {
    console.log('–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –¥–∏–∞–ª–æ–≥ —Å –±–æ—Ç–æ–º');
    await sendWelcomeMessage(ctx);
  });

  // –ö–æ–º–∞–Ω–¥–∞ –ø–æ–º–æ—â–∏
  bot.command('help', async (ctx) => {
    await ctx.reply(
      `üÜò **–ü–æ–º–æ—â—å –ø–æ –±–æ—Ç—É**\n\n` +
      `–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.\n` +
      `–ö–æ–º–∞–Ω–¥–∞ /start - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞.`,
      {
        format: 'markdown',
        attachments: [getAbiturientMenu()]
      }
    );

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
  
  });

  bot.on('message_created', async (ctx) => {
     if (ctx.message.body.text && !ctx.message.body.text.startsWith('/')) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–≤–æ–¥–æ–º –±–∞–ª–ª–æ–≤ –ï–ì–≠
        const scores = parseScores(ctx.message.body.text.toLowerCase());
        if (Object.keys(scores).length > 0) {
            // –ï—Å–ª–∏ —ç—Ç–æ –±–∞–ª–ª—ã –ï–ì–≠, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ handleUnknownMessage
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ —Å–∞–º –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
            return;
        }
        
        await handleUnknownMessage(ctx);
    }
  });

  // –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ–¥–ª–∞–π–Ω–æ–≤
  bot.command('deadlines', async (ctx) => {
    const deadlinesKeyboard = Keyboard.inlineKeyboard([
      [Keyboard.button.callback('üìÖ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ–¥–ª–∞–π–Ω—ã', 'deadlines:view')]
    ]);

    await ctx.reply('–ü–µ—Ä–µ–π–¥–∏—Ç–µ –∫ –ø—Ä–æ—Å–º–æ—Ç—Ä—É –¥–µ–¥–ª–∞–π–Ω–æ–≤:', {
      attachments: [deadlinesKeyboard]
    });
  });

  // –ö–æ–Ω—Ç–∞–∫—Ç—ã
  bot.action('contacts:view', async (ctx) => {
    try {
      const location = new LocationAttachment({ 
        lat: 43.117778, 
        lon: 131.893056
      });

      await ctx.reply(
        `**üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏**\n\n` +
        `üìç –ê–¥—Ä–µ—Å: –ö–∞–º–ø—É—Å –î–í–§–£, –ì–†-3, –í–ª–∞–¥–∏–≤–æ—Å—Ç–æ–∫, –ü—Ä–∏–º–æ—Ä—Å–∫–∏–π –∫—Ä–∞–π\n` +
        `üìû –¢–µ–ª–µ—Ñ–æ–Ω: 8-800-550-38-38\n` +
        `‚úâÔ∏è Email: pochta_priemki.ru\n\n` +
        `üïí **–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:**\n` +
        `–ü–Ω-–ü—Ç: 9:00-18:00\n` +
        `–°–±: 10:00-16:00\n` +
        `–í—Å: –≤—ã—Ö–æ–¥–Ω–æ–π`,
        {
          format: 'markdown',
          attachments: [location.toJson(), getAbiturientMenu()]
        }
      );
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≤ contacts:view:', error);
      await ctx.reply('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.');
    }
  });

  // –î–æ–∫—É–º–µ–Ω—Ç—ã
  bot.action('documents:list', async (ctx) => {
    try {
      const documents = [
        "üìÑ –ü–∞—Å–ø–æ—Ä—Ç (–æ—Ä–∏–≥–∏–Ω–∞–ª + –∫–æ–ø–∏—è)",
        "üìÑ –ê—Ç—Ç–µ—Å—Ç–∞—Ç (–æ—Ä–∏–≥–∏–Ω–∞–ª + –∫–æ–ø–∏—è)", 
        "üìÑ 4 —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ 3x4 —Å–º",
        "üìÑ –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∞—è —Å–ø—Ä–∞–≤–∫–∞ 086/—É",
        "üìÑ –î–æ–∫—É–º–µ–Ω—Ç—ã –æ –ª—å–≥–æ—Ç–∞—Ö (–ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏)",
        "üìÑ –°–ù–ò–õ–° (–∫–æ–ø–∏—è)"
      ];

      await ctx.reply(
        "–ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:\n\n" +
        documents.join('\n') +
        "\n\nüìù –ó–∞—è–≤–ª–µ–Ω–∏–µ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –ø—Ä–∏–µ–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–∏",
        {
          format: 'markdown',
          attachments: [getAbiturientMenu()]
        } +
        documents.join('\n') +
        '–ò–ª–∏ –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–∞—Ç—å –∑–∞—è–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–∞–π—Ç –ì–æ—Å—É—Å–ª—É–≥–∏'
        
      );
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≤ documents:list:', error);
      await ctx.reply('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.');
    }
  });

  // –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
  bot.action('menu:main', async (ctx) => {
    await ctx.reply('–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é:', {
      attachments: [getAbiturientMenu()]
    });
  });

  async function handleUnknownMessage(ctx) {
  const userMessage = ctx.message.body.text.toLowerCase();
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—Ö–æ–∂–µ –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å
  const isQuestion = /^(—á—Ç–æ|–∫–∞–∫|–≥–¥–µ|–∫–æ–≥–¥–∞|–ø–æ—á–µ–º—É|–∑–∞—á–µ–º|–∫—Ç–æ|–∫—É–¥–∞)\s+|[\?]/.test(userMessage);
  
  let response = '';

  if (isQuestion) {
    response = `–ü–æ—Ö–æ–∂–µ, —É –≤–∞—Å –≤–æ–ø—Ä–æ—Å!\n\n` +
      `–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, —è –ø–æ–∫–∞ –Ω–µ —É–º–µ—é –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã. ` +
      `–ù–æ —è –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å:\n\n` +
      `‚Ä¢ üìã –ß–∞—Å—Ç—ã–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏ –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏\n` +
      `‚Ä¢ üéì –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è—Ö –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏\n` +
      `‚Ä¢ üßÆ –†–∞—Å—á–µ—Ç–æ–º —à–∞–Ω—Å–æ–≤ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è\n` +
      `‚Ä¢ üìÖ –î–µ–¥–ª–∞–π–Ω–∞–º–∏ –ø–æ–¥–∞—á–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤\n\n` +
      `–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Ä–∞–∑–¥–µ–ª –≤ –º–µ–Ω—é –Ω–∏–∂–µ ‚Üì`;
  } else {
    response = `ü§ñ –±–æ—Ç-–ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç–æ–≤ –î–í–§–£\n\n` +
      `–Ø –Ω–µ —Å–æ–≤—Å–µ–º –ø–æ–Ω—è–ª, —á—Ç–æ –≤—ã –∏–º–µ–µ—Ç–µ –≤ –≤–∏–¥—É. ` +
      `–ù–æ —è –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º!\n\n` +
      `–í–æ—Ç —á—Ç–æ —è —É–º–µ—é:\n` +
      `‚Ä¢ –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏\n` +
      `‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏\n` +
      `‚Ä¢ –†–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å —à–∞–Ω—Å—ã –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è\n` +
      `‚Ä¢ –ù–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –¥–µ–¥–ª–∞–π–Ω–∞—Ö\n\n` +
      `–ü—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –≤ –º–µ–Ω—é‚Üì\n`;
  }

  await ctx.reply(response, {
    format: 'markdown',
    attachments: [getAbiturientMenu()]
  });
}
}